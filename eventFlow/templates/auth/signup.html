{% extends 'base.html' %}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="/static/css/auth.css" />
{% endblock %}
{% block title %}
  Sign Up - eventFlow
{% endblock %}
{% block breadcrumb_items %}
  <div class="breadcrumb-wrapper">
    <ul class="breadcrumb-list">
      <li class="breadcrumb-item">
        <a href="{{ url_for('main.home') }}">Home</a>
      </li>
      <li class="breadcrumb-item active">Find Events</li>
    </ul>
  </div>
{% endblock %}
{% block content %}
  <div class="auth-container">
    <div class="auth-card">
      <!-- Step One -->
      <div id="step-one" class="signup-step active">
        <h1>Get Started</h1>
        <p class="auth-subtitle">Create your account to start organizing and discovering events</p>

        <div class="social-login">
          <button class="social-btn google-btn">
            <img src="/static/images/google.svg" alt="Google" width="20" height="20" />
            Sign in with Google
          </button>
        </div>

        <div class="divider">
          <span>or</span>
        </div>

        <div class="form-group">
          <label for="initial-email">Email</label>
          <input type="email" id="initial-email" class="form-control" placeholder="name@example.com" />
        </div>

        <button type="button" id="continue-btn" class="btn btn-primary btn-block">Continue with Email</button>

        <div class="auth-footer">
          <p>
            Already have an account? <a href="{{ url_for('auth.login') }}">Log In</a>
          </p>
        </div>
      </div>

      <!-- Step Two -->
      <div id="step-two" class="signup-step">
        <h2 class="step-title">Complete Your Profile</h2>
        <p class="step-description">Fill in your details to finish creating your account</p>

        <form method="POST" action="{{ url_for('auth.signup') }}" class="auth-form" id="signupForm">
          {{ form.hidden_tag() }}

          <!-- Email Fields -->
          <div class="form-section">
            <div class="form-group">
              <div class="email-field-wrapper">
                {{ form.email.label }}
                <div class="input-with-icon">
                  {{ form.email(class='form-control', readonly=true) }}
                  <button type="button" class="edit-email-btn" aria-label="Edit email"><span class="material-icons">edit</span></button>
                </div>
              </div>
            </div>

            <div class="form-group">
              {{ form.confirm_email.label }}
              {{ form.confirm_email(class='form-control', placeholder='Confirm email') }}
              {% if form.confirm_email.errors %}
                {% for error in form.confirm_email.errors %}
                  <span class="error-message">{{ error }}</span>
                {% endfor %}
              {% endif %}
            </div>
          </div>

          <!-- Name Fields -->
          <div class="form-section">
            <div class="name-row">
              <div class="form-group">
                {{ form.first_name.label }}
                {{ form.first_name(class='form-control', placeholder='First name') }}
                {% if form.first_name.errors %}
                  {% for error in form.first_name.errors %}
                    <span class="error-message">{{ error }}</span>
                  {% endfor %}
                {% endif %}
              </div>

              <div class="form-group">
                {{ form.last_name.label }}
                {{ form.last_name(class='form-control', placeholder='Last name') }}
                {% if form.last_name.errors %}
                  {% for error in form.last_name.errors %}
                    <span class="error-message">{{ error }}</span>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Password Field -->
          <div class="form-section">
            <div class="form-group">
              {{ form.password.label }}
              {{ form.password(class='form-control', placeholder='••••••••') }}
              {% if form.password.errors %}
                {% for error in form.password.errors %}
                  <span class="error-message">{{ error }}</span>
                {% endfor %}
              {% endif %}
            </div>
          </div>

          <!-- Terms Checkbox -->
          <div class="form-section">
            <div class="checkbox-wrapper">
              {{ form.accept_terms(class='form-checkbox') }}
              {{ form.accept_terms.label }}
              {% if form.accept_terms.errors %}
                {% for error in form.accept_terms.errors %}
                  <span class="error-message">{{ error }}</span>
                {% endfor %}
              {% endif %}
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">Create Account</button>
        </form>

        <div class="auth-footer">
          <p>
            Already have an account? <a href="{{ url_for('auth.login') }}">Log In</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const stepOne = document.getElementById('step-one')
      const stepTwo = document.getElementById('step-two')
      const continueBtn = document.getElementById('continue-btn')
      const initialEmail = document.getElementById('initial-email')
      const signupEmail = document.querySelector('[name="email"]')
      const confirmEmail = document.querySelector('[name="confirm_email"]')
      const editEmailBtn = document.querySelector('.edit-email-btn')
      let errorDiv = null
    
      function removeErrorMessage() {
        if (errorDiv && errorDiv.parentNode) {
          errorDiv.parentNode.removeChild(errorDiv)
          errorDiv = null
        }
      }
    
      function showErrorMessage(message, element) {
        removeErrorMessage()
        errorDiv = document.createElement('div')
        errorDiv.className = 'error-message'
        errorDiv.textContent = message
        element.parentNode.appendChild(errorDiv)
      }
    
      function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
      }
    
      async function checkEmailAvailability(email) {
        try {
          const response = await fetch('/auth/check-email', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: email })
          })
          const data = await response.json()
          return data.available
        } catch (error) {
          console.error('Error checking email:', error)
          return false
        }
      }
    
      function switchToStepTwo(email) {
        stepOne.classList.remove('active')
        stepTwo.classList.add('active')
        signupEmail.value = email
        confirmEmail.value = ''
        signupEmail.readOnly = true
      }
    
      function switchToStepOne(email) {
        stepTwo.classList.remove('active')
        stepOne.classList.add('active')
        initialEmail.value = email
        removeErrorMessage()
      }
    
      continueBtn.addEventListener('click', async function () {
        const email = initialEmail.value.trim()
        removeErrorMessage()
    
        if (!email) {
          showErrorMessage('Please enter your email address', initialEmail)
          return
        }
    
        if (!isValidEmail(email)) {
          showErrorMessage('Please enter a valid email address', initialEmail)
          return
        }
    
        // Check if email is available
        const isAvailable = await checkEmailAvailability(email)
        if (!isAvailable) {
          showErrorMessage('An account with this email already exists. Please log in instead.', initialEmail)
          setTimeout(() => {
            window.location.href = "{{ url_for('auth.login') }}"
          }, 3000)
          return
        }
    
        switchToStepTwo(email)
      })
    
      editEmailBtn.addEventListener('click', function () {
        switchToStepOne(signupEmail.value)
      })
    
      confirmEmail.addEventListener('input', function () {
        removeErrorMessage()
        if (confirmEmail.value !== signupEmail.value) {
          showErrorMessage('Email address do not match. Please try again', confirmEmail)
        }
      })
    
      const signupForm = document.getElementById('signupForm')
      signupForm.addEventListener('submit', function (e) {
        if (confirmEmail.value !== signupEmail.value) {
          e.preventDefault()
          showErrorMessage('Email addresses do not match. Please try again', confirmEmail)
          return
        }
      })
    })
  </script>
{% endblock %}
